# Firestore Integration Documentation

## Overview
Both **Plant Care AI** and **Recipe Generation** features now fully integrate with Firebase Firestore for persistent data storage and history tracking.

## Collections Structure

### 1. `plantCares` Collection
Stores all plant care plans generated by users.

**Document Structure:**
```typescript
{
  userId: string,           // User identifier (currently 'demo-user')
  plantName: string,        // Name of the plant
  growthStage: string,      // 'seedling' | 'vegetative' | 'fruiting' | 'dormant'
  country: string,          // Country/location
  formData: {               // Complete form data
    plantName: string,
    growthStage: string,
    country: string,
    hardinessZone?: string,
    rainfallPattern?: string,
    avgTempC?: number,
    biodiversityConcerns: string,
    photoUrls: string[]
  },
  carePlan: {               // Generated care plan
    title: string,
    summary: string,
    wateringSchedule: string,
    soilTips: string,
    sunlight: string,
    warnings: string[],
    nextSteps: string[]
  },
  timestamp: Timestamp      // Firebase server timestamp
}
```

**Indexes Required:**
- `userId` (ascending) + `timestamp` (descending)

### 2. `recipes` Collection
Stores all recipes generated by users.

**Document Structure:**
```typescript
{
  userId: string,           // User identifier (currently 'demo-user')
  formData: {               // Complete form data
    dietaryNeeds: string[],
    availableIngredients: string,
    culturalPreferences: string[],
    season?: string,
    pantryPhotoUrls: string[]
  },
  recipes: [                // Array of generated recipes
    {
      title: string,
      description: string,
      ingredients: string[],
      instructions: string[],
      prepTime?: string,
      cookTime?: string,
      servings?: string,
      culturalNotes?: string,
      nutritionHighlights?: string[]
    }
  ],
  timestamp: Timestamp      // Firebase server timestamp
}
```

**Indexes Required:**
- `userId` (ascending) + `timestamp` (descending)

## Features Implemented

### Plant Care Page (`PlantCarePage.tsx`)
✅ **Save Functionality:**
- Automatically saves care plans to Firestore after successful API generation
- Stores complete form data and AI response
- Includes timestamp for chronological sorting

✅ **History Display:**
- Loads last 5 care plans on page mount
- Shows plant name and date
- Real-time updates after new plan generation
- Empty state message when no history exists

### Recipes Page (`RecipesPage.tsx`)
✅ **Save Functionality:**
- Automatically saves recipes to Firestore after successful API generation
- Stores complete form data and all generated recipes
- Includes timestamp for chronological sorting

✅ **History Display:**
- Loads last 5 recipe entries on page mount
- Shows recipe title and date
- Real-time updates after new recipe generation
- Empty state message when no history exists

## Implementation Details

### Firebase Configuration
Location: `src/lib/firebase.ts`

```typescript
import { initializeApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

export { db };
```

### Firestore Operations Used

**1. Save Document:**
```typescript
import { collection, addDoc, Timestamp } from 'firebase/firestore';

await addDoc(collection(db, 'collectionName'), {
  userId: 'demo-user',
  // ... data
  timestamp: Timestamp.now()
});
```

**2. Query Documents:**
```typescript
import { query, where, orderBy, limit, getDocs } from 'firebase/firestore';

const q = query(
  collection(db, 'collectionName'),
  where('userId', '==', 'demo-user'),
  orderBy('timestamp', 'desc'),
  limit(5)
);
const querySnapshot = await getDocs(q);
```

### User Context
Currently using hardcoded `'demo-user'` as the userId. This should be replaced with actual authenticated user ID when Firebase Authentication is implemented.

**TODO for Authentication Integration:**
```typescript
// Replace 'demo-user' with actual user ID:
import { getAuth } from 'firebase/auth';

const auth = getAuth();
const userId = auth.currentUser?.uid || 'anonymous';
```

## Environment Variables Required

Ensure these Firebase environment variables are set in `.env`:

```env
VITE_FIREBASE_API_KEY=your_api_key
VITE_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your_project_id
VITE_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
VITE_FIREBASE_APP_ID=your_app_id
VITE_FIREBASE_MEASUREMENT_ID=your_measurement_id
```

## Security Rules

**Recommended Firestore Security Rules:**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Plant Care collection
    match /plantCares/{document} {
      // Allow read/write only for authenticated users on their own documents
      allow read, write: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Recipes collection
    match /recipes/{document} {
      // Allow read/write only for authenticated users on their own documents
      allow read, write: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
    }
  }
}
```

**For Development (Temporary):**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;  // WARNING: Only for development!
    }
  }
}
```

## Testing

### Manual Testing Steps

**1. Test Plant Care Firestore Integration:**
```bash
# Start dev server
npm run dev

# Navigate to http://localhost:5173/plant-care
# Fill out the form and submit
# Check Firestore console for new document in 'plantCares' collection
# Verify history section updates with the new entry
```

**2. Test Recipe Generation Firestore Integration:**
```bash
# Navigate to http://localhost:5173/recipes
# Fill out the form and submit
# Check Firestore console for new document in 'recipes' collection
# Verify history section updates with the new entry
```

**3. Check Firestore Console:**
- Go to Firebase Console → Firestore Database
- Verify collections exist: `plantCares` and `recipes`
- Check document structure matches expected schema
- Verify timestamps are correct
- Confirm userId field is present

### Error Handling

Both features include graceful error handling:

```typescript
try {
  await addDoc(collection(db, 'collectionName'), data);
  // Refresh history
} catch (firestoreErr) {
  console.error('Error saving to Firestore:', firestoreErr);
  // Don't show error to user, just log it
}
```

**Rationale:** Firestore save failures shouldn't block the user experience. The AI response is still shown even if saving fails.

## Performance Considerations

1. **Query Limits:** Queries are limited to 5 most recent documents to minimize reads
2. **Index Usage:** Composite indexes on `userId` + `timestamp` ensure fast queries
3. **Client-Side Caching:** Firestore SDK automatically caches queries for offline support
4. **Lazy Loading:** History only loads on page mount, not on every render

## Future Enhancements

### Planned Features:
- [ ] Add pagination for history (load more button)
- [ ] Implement search/filter in history
- [ ] Add ability to view/load previous care plans and recipes
- [ ] Enable deletion of history entries
- [ ] Add favorites/bookmarking functionality
- [ ] Implement real-time updates using `onSnapshot()`
- [ ] Add user authentication with Firebase Auth
- [ ] Create user profile page showing all history
- [ ] Export history to PDF/CSV
- [ ] Add sharing functionality for recipes and care plans

### Real-time Updates Example:
```typescript
// Replace getDocs with onSnapshot for live updates
import { onSnapshot } from 'firebase/firestore';

useEffect(() => {
  const q = query(
    collection(db, 'recipes'),
    where('userId', '==', userId),
    orderBy('timestamp', 'desc'),
    limit(5)
  );
  
  const unsubscribe = onSnapshot(q, (snapshot) => {
    const historyData = snapshot.docs.map(doc => ({
      id: doc.id,
      title: doc.data().recipes?.[0]?.title,
      timestamp: doc.data().timestamp.toDate()
    }));
    setHistory(historyData);
  });
  
  return () => unsubscribe();
}, [userId]);
```

## Code Metrics

**Plant Care Integration:**
- Lines added: ~55
- New imports: 6 (Firestore functions)
- State additions: 1 (`history` array)
- New useEffect hook: 1 (load history)
- Firestore operations: 2 (save + query)

**Recipe Generation Integration:**
- Lines added: ~75
- New imports: 6 (Firestore functions)
- State additions: 1 (`history` array)
- New useEffect hook: 1 (load history)
- Firestore operations: 2 (save + query)

**Total Impact:**
- Total lines: ~130
- Collections: 2
- No breaking changes
- Backward compatible (works without Firestore)

## Troubleshooting

### Common Issues:

**1. "Permission denied" errors:**
- Check Firestore security rules
- Verify Firebase config is correct
- Ensure user is authenticated (or use dev rules)

**2. History not loading:**
- Check browser console for errors
- Verify Firestore indexes are created
- Check network tab for failed requests

**3. Timestamp errors:**
- Ensure using `Timestamp.now()` from Firebase
- Don't use `new Date()` for Firestore timestamps

**4. Missing documents:**
- Check collection names match exactly
- Verify userId is consistent
- Check if documents are being filtered by query

## Dependencies

No new dependencies required. Uses existing Firebase packages:
- `firebase` (already installed)
- `firebase/firestore` (part of Firebase SDK)
- `firebase/app` (already used)

## Browser Support

Firestore SDK supports:
- Chrome 61+
- Firefox 60+
- Safari 12.1+
- Edge 79+
- Mobile browsers (iOS Safari 12.2+, Chrome Android 61+)

## Summary

✅ **Plant Care Page:** Fully integrated with Firestore
✅ **Recipe Generation Page:** Fully integrated with Firestore  
✅ **History Tracking:** Both features show recent 5 entries
✅ **Auto-Save:** Data saved automatically after API success
✅ **Error Handling:** Graceful failures with console logging
✅ **TypeScript:** Full type safety maintained
✅ **Performance:** Optimized queries with limits and indexes

**Status:** Production-ready (pending authentication integration)

# Firebase Recipe Storage Implementation ‚úÖ

## Overview
Recipes generated by the AI are automatically saved to Firebase Firestore, allowing users to access their recipe history and save favorites.

## Firebase Collections

### 1. `recipes` Collection
**Purpose**: Stores recipe generation sessions  
**Document Structure**:
```typescript
{
  userId: string;           // User identifier (currently 'demo-user')
  formData: {               // Original form data used to generate recipes
    dietaryNeeds: string[];
    availableIngredients: string;
    culturalPreferences: string[];
    season?: string;
    pantryPhotoUrls: string[];
  };
  recipes: Recipe[];        // Array of generated recipes
  timestamp: Timestamp;     // When recipes were generated
  type: 'generation-session';
}
```

**Firestore Index Required**:
- Collection: `recipes`
- Fields: `userId` (Ascending) + `type` (Ascending) + `timestamp` (Descending)

### 2. `user-recipes` Collection (NEW)
**Purpose**: Stores individual recipes for easier querying  
**Document Structure**:
```typescript
{
  userId: string;           // User identifier
  sessionId: string;        // Reference to parent recipes document
  recipe: {                 // Complete recipe object
    title: string;
    description: string;
    ingredients: string[];
    instructions: string[];
    prepTime?: string;
    cookTime?: string;
    servings?: string;
    difficulty?: string;
    nutritionHighlights?: string[];
    culturalNotes?: string;
    tips?: string[];
  };
  formData: {               // Context from generation
    dietaryNeeds: string[];
    culturalPreferences: string[];
    season?: string;
  };
  timestamp: Timestamp;     // When saved
  isFavorite: boolean;      // False by default
  tags: string[];           // Auto-generated from dietary needs, cultural prefs, season
}
```

**Firestore Index Required**:
- Collection: `user-recipes`
- Fields: `userId` (Ascending) + `timestamp` (Descending)

### 3. `favorite-recipes` Collection (NEW)
**Purpose**: Stores user's favorite recipes  
**Document Structure**:
```typescript
{
  userId: string;           // User identifier
  recipe: Recipe;           // Complete recipe object
  timestamp: Timestamp;     // When favorited
  tags: string[];           // For categorization and search
}
```

**Firestore Index Required**:
- Collection: `favorite-recipes`
- Fields: `userId` (Ascending) + `timestamp` (Descending)

## Features Implemented

### 1. Automatic Recipe Saving ‚úÖ
When recipes are generated:
- **Recipe session** saved to `recipes` collection
- **Individual recipes** saved to `user-recipes` collection (one document per recipe)
- **History updated** automatically from Firestore
- **Tags generated** automatically from form data

**Code Location**: `src/pages/RecipesPage.tsx` lines 405-463

```typescript
// Save the recipe generation session
const sessionDoc = await addDoc(collection(getDb(), 'recipes'), {
  userId: 'demo-user',
  formData: formData,
  recipes: recipesArray,
  timestamp: Timestamp.now(),
  type: 'generation-session'
});

// Save each individual recipe
const savePromises = recipesArray.map(async (recipe) => {
  return addDoc(collection(getDb(), 'user-recipes'), {
    userId: 'demo-user',
    sessionId: sessionDoc.id,
    recipe: recipe,
    formData: {
      dietaryNeeds: formData.dietaryNeeds,
      culturalPreferences: formData.culturalPreferences,
      season: formData.season
    },
    timestamp: Timestamp.now(),
    isFavorite: false,
    tags: [...formData.dietaryNeeds, ...formData.culturalPreferences, formData.season].filter(Boolean)
  });
});

await Promise.all(savePromises);
```

### 2. Save to Favorites ‚úÖ
Users can save individual recipes to favorites:
- Click ‚ù§Ô∏è button on any recipe card
- Recipe saved to `favorite-recipes` collection
- Success message displayed for 3 seconds
- Works even if original session is deleted

**Code Location**: `src/pages/RecipesPage.tsx` lines 256-275

```typescript
const saveRecipeToFavorites = async (recipe: Recipe) => {
  try {
    await addDoc(collection(getDb(), 'favorite-recipes'), {
      userId: 'demo-user',
      recipe: recipe,
      timestamp: Timestamp.now(),
      tags: [
        ...(formData.dietaryNeeds || []),
        ...(formData.culturalPreferences || []),
        recipe.category
      ].filter(Boolean)
    });
    
    setSavedMessage(`‚úÖ "${recipe.title}" saved to favorites!`);
    setTimeout(() => setSavedMessage(null), 3000);
  } catch (err) {
    console.error('Error saving recipe to favorites:', err);
    setSavedMessage('‚ùå Failed to save recipe. Please try again.');
  }
};
```

### 3. Recipe History ‚úÖ
Recent recipes displayed in sidebar:
- Shows 5 most recent recipe sessions
- Loads on page mount
- Updates after new generation
- Displays title and timestamp

**Code Location**: `src/pages/RecipesPage.tsx` lines 234-254

```typescript
useEffect(() => {
  const loadHistory = async () => {
    try {
      const q = query(
        collection(getDb(), 'recipes'),
        where('userId', '==', 'demo-user'),
        where('type', '==', 'generation-session'),
        orderBy('timestamp', 'desc'),
        limit(5)
      );
      const querySnapshot = await getDocs(q);
      const historyData = querySnapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          title: data.recipes?.[0]?.title || 'Recipe',
          timestamp: data.timestamp.toDate()
        };
      });
      setHistory(historyData);
    } catch (err) {
      console.error('Error loading history:', err);
    }
  };
  loadHistory();
}, []);
```

## User Interface

### Recipe Cards with Save Button
Each recipe card includes:
- ‚ù§Ô∏è **Favorite button** (top-right corner)
- **Spotlight badge** for featured recipe
- **Recipe details** (prep time, cook time, servings, difficulty)
- **Collapsible full recipe** (ingredients, instructions, nutrition, cultural notes)

### Success/Error Messages
- **Green alert** when recipe saved successfully
- **Red alert** if save fails
- **Auto-dismisses** after 3 seconds

### Recipe History Sidebar
- Shows 5 most recent sessions
- Displays recipe title
- Shows generation date
- Located in right sidebar below generated recipes

## Firebase Security Rules

Current rules allow read/write access (development mode):

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Recipes collection
    match /recipes/{recipeId} {
      allow read, write: if true;
    }
    
    // User recipes collection
    match /user-recipes/{recipeId} {
      allow read, write: if true;
    }
    
    // Favorite recipes collection
    match /favorite-recipes/{recipeId} {
      allow read, write: if true;
    }
  }
}
```

**Production Rules** (recommended):
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Recipes collection - user can only access their own
    match /recipes/{recipeId} {
      allow read, write: if request.auth != null && 
                          request.resource.data.userId == request.auth.uid;
    }
    
    // User recipes - user can only access their own
    match /user-recipes/{recipeId} {
      allow read, write: if request.auth != null && 
                          request.resource.data.userId == request.auth.uid;
    }
    
    // Favorites - user can only access their own
    match /favorite-recipes/{recipeId} {
      allow read, write: if request.auth != null && 
                          request.resource.data.userId == request.auth.uid;
    }
  }
}
```

## Firestore Indexes Required

### Create These Indexes in Firebase Console

1. **For recipes collection**:
   - Go to: https://console.firebase.google.com/project/planted-dea3b/firestore/indexes
   - Create composite index:
     - Collection: `recipes`
     - Field 1: `userId` (Ascending)
     - Field 2: `type` (Ascending)
     - Field 3: `timestamp` (Descending)

2. **For user-recipes collection**:
   - Create composite index:
     - Collection: `user-recipes`
     - Field 1: `userId` (Ascending)
     - Field 2: `timestamp` (Descending)

3. **For favorite-recipes collection**:
   - Create composite index:
     - Collection: `favorite-recipes`
     - Field 1: `userId` (Ascending)
     - Field 2: `timestamp` (Descending)

## Error Handling

### Graceful Degradation
- If Firebase not configured: Recipes still display (just not saved)
- If save fails: User sees error message, but recipes remain usable
- If index missing: Console shows link to create index

### Error Messages
```typescript
try {
  // Save to Firebase
} catch (firestoreErr: any) {
  console.error('Error saving to Firestore:', firestoreErr);
  if (firestoreErr.message?.includes('requires an index')) {
    console.warn('üí° Firestore index required. Check console for index creation link.');
  }
}
```

## Testing the Feature

### Local Testing (Development)
```bash
# 1. Start the development server
npm run dev

# 2. Open http://localhost:5173/recipes

# 3. Generate recipes:
#    - Select dietary needs (e.g., Vegan)
#    - Enter ingredients: "chickpeas, tomatoes, spinach"
#    - Select cultural preference: Mediterranean
#    - Click "Generate Recipes"

# 4. Check browser console for:
#    ‚úÖ Recipe session saved to Firebase: [document-id]
#    ‚úÖ 3 individual recipes saved to Firebase

# 5. Click ‚ù§Ô∏è button on any recipe
#    - Should see: "‚úÖ Recipe saved to favorites!"

# 6. Check Firestore Console:
#    - recipes collection: Should have new document
#    - user-recipes collection: Should have 3 new documents
#    - favorite-recipes collection: Should have 1 new document
```

### Production Testing (Vercel)
```bash
# 1. Open https://planted-ashy.vercel.app/recipes

# 2. Generate recipes (same as local)

# 3. Open browser DevTools (F12)
#    - Console should show Firebase save confirmations

# 4. Verify in Firebase Console:
#    https://console.firebase.google.com/project/planted-dea3b/firestore/data
```

## Future Enhancements

### 1. User Authentication
Replace hardcoded `'demo-user'` with actual Firebase Authentication:
```typescript
import { getAuth } from 'firebase/auth';

const auth = getAuth();
const userId = auth.currentUser?.uid || 'anonymous';
```

### 2. Recipe Search
Query recipes by tags:
```typescript
const q = query(
  collection(getDb(), 'user-recipes'),
  where('userId', '==', userId),
  where('tags', 'array-contains', 'Vegan'),
  orderBy('timestamp', 'desc')
);
```

### 3. Recipe Sharing
Add share functionality:
```typescript
await addDoc(collection(getDb(), 'shared-recipes'), {
  originalUserId: userId,
  recipe: recipe,
  shareCode: generateShareCode(),
  timestamp: Timestamp.now(),
  views: 0
});
```

### 4. Meal Planning
Create meal plans from saved recipes:
```typescript
await addDoc(collection(getDb(), 'meal-plans'), {
  userId: userId,
  weekOf: Timestamp.now(),
  meals: {
    monday: { breakfast: recipeId1, lunch: recipeId2 },
    tuesday: { breakfast: recipeId3, lunch: recipeId4 }
  },
  timestamp: Timestamp.now()
});
```

### 5. Recipe Collections
Allow users to organize recipes into collections:
```typescript
await addDoc(collection(getDb(), 'recipe-collections'), {
  userId: userId,
  name: 'Summer BBQ Favorites',
  description: 'Perfect recipes for outdoor gatherings',
  recipeIds: [recipeId1, recipeId2, recipeId3],
  timestamp: Timestamp.now()
});
```

## Troubleshooting

### "Missing or insufficient permissions"
- **Cause**: Firestore security rules rejecting writes
- **Fix**: Update rules in Firebase Console or use development rules temporarily

### "The query requires an index"
- **Cause**: Composite index not created
- **Fix**: Click the link in error message to create index, or create manually in Firebase Console

### Recipes not saving but no error
- **Cause**: Firebase environment variables not configured
- **Fix**: Add all 7 `VITE_FIREBASE_*` variables to `.env.local` (local) or Vercel (production)

### History not loading
- **Cause**: Index missing or query filtering wrong documents
- **Fix**: Ensure `type: 'generation-session'` field exists and index includes it

## Summary

‚úÖ **Automatic Saving**: All generated recipes saved to Firebase  
‚úÖ **Individual Recipes**: Each recipe saved separately for easier querying  
‚úÖ **Favorites**: Users can save recipes to favorites with ‚ù§Ô∏è button  
‚úÖ **History**: Recent recipes displayed in sidebar  
‚úÖ **Tags**: Auto-generated from dietary needs, culture, season  
‚úÖ **Error Handling**: Graceful degradation if Firebase unavailable  
‚úÖ **Production Ready**: Works on Vercel with Firebase environment variables  

**Your recipes are now persistently stored in Firebase Firestore!** üéâ
